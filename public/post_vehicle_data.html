<!DOCTYPE html>
<html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
      <link href="lib/bootstrap.min.css" rel="stylesheet">

      <!-- vehicle api 必須 : ここから-->
      <script src="http://52.193.125.145:3000/socket.io/socket.io.js"></script> 
      <script src="http://52.193.125.145:3000/www/js/vehicleAPI.js"></script>
      <script src="http://52.193.125.145:3000/www/js/vehicleAPI-client.js"></script>
      <script>
        var roomID = "cherassco";

        window.onload = function () {
          document.getElementById( "room-id" ).innerHTML = roomID;
          var msg = { "roomID":roomID, "data":"NOT REQUIRED" };
          socket.emit( 'joinRoom', JSON.stringify( msg ) )
        }
      </script>
      <!-- vehicle api 必須 : ここまで -->

      <script>
        var data = {
          vehicle_speed: false,
          engine_speed: false,
          acceleration_x: false,
          acceleration_y: false,
          acceleration_z: false,
          gyro_x: false,
          gyro_y: false,
          gyro_z: false,
          steering_wheel: false,
          latitude: false,
          longitude: false,
          altitude: false,
          gps_heading: false,
          gps_speed: false
        };

        var datas = [];

        var data_completed = false;
        var data_updated = false;

        var vehicle_speed_sub = navigator.vehicle.vehicleSpeed.subscribe( function( vehicle_speed ){
          data.vehicle_speed = vehicle_speed.speed;
          $( "#vehicle-speed" ).text( vehicle_speed.speed );
          data_updated = true;
        });

        var engine_speed_sub = navigator.vehicle.engineSpeed.subscribe( function( engine_speed ){
          data.engine_speed = engine_speed.speed;
          data_updated = true;
        });

        var acceleration_sub = navigator.vehicle.acceleration.subscribe( function( acceleration ){
          data.acceleration_x = acceleration.x;
          data.acceleration_y = acceleration.y;
          data.acceleration_z = acceleration.z;
          data_updated = true;
        });

        var gyro_sub = navigator.vehicle.gyro.subscribe( function( gyro ){
          data.gyro_x = gyro.pitchRate;
          data.gyro_y = gyro.rollRate;
          data.gyro_z = gyro.yawRate;
          data_updated = true;
        });

        var steering_wheel_sub = navigator.vehicle.steeringWheel.subscribe( function( steering_wheel ){
          data.steering_wheel = steering_wheel.angle;
          data_updated = true;
        });

        var gps_sub = navigator.vehicle.location.subscribe( function( gps ){
          data.latitude = gps.latitude;
          data.longitude = gps.longitude;
          data.altitude = gps.altitude;
          data.gps_heading = gps.heading;
          data.gps_speed = gps.speed;
          data_updated = true;
        });

        setInterval( "storeData()", 500 );

        function storeData(){
          if( !data_completed ){
            data_completed = true;
            for( key in datas ){
              data_completed = data_completed && datas[ key ];
            }
            return;
          }

          datas.push( data );
          if( datas.length == 10 ){
            // TODO: post
            if( data_updated ){
              console.log( datas );
            }
            datas = [];
            data_updated = false;
          }
        }

      </script>
    </head>
    <body>
      <h1>Posting Vehicle Data</h1>

      <ul class="list-group">
        <li class="list-group-item">
          <span id="room-id" class="badge"></span>
          Room ID
        </li>
        <li class="list-group-item">
          <span id="vehicle-speed" class="badge">false</span>
          VehicleSpeed
        </li>
      </ul>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      <script src="lib/bootstrap.min.js"></script>
    </body>
</html>
